<template>
  <div data-page="my-events" class="page">

    <!-- Top Navbar-->
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="back link">
            <i class="icon icon-back md-only"></i>
            <i class="f7-icons ios-only">chevron_left</i>
            <span class="white">Back</span>
          </a>
        </div>
        <div class="title sliding">My Events</div>
        <!-- <div class="right">
          <a class="link" href="/add-event/"><i class="f7-icons">add</i></a>
        </div> -->
      </div>
    </div>
    <!--End Navbar-->

    <!-- content goes here -->
        <div class="page-content">
          <div class="block-title">Swipe Event to Remove from My Events</div>
          <div class="list">
            <div id="myEventList">
              <!--Javascrist list injected here-->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  return {
    on: {
      pageInit: function () {
        // get events for this user
        myEvents = [];
        myEventsRef.orderByKey().equalTo(app.user.uid).limitToFirst(1).on("child_added", function(snapshot) {
          var eventData = snapshot.val();
          // debugger;
          for (var key in eventData) {
            console.log('Event Key:' + eventData[key].eventkey)
            myEvents.push(eventData[key].eventkey)
          }

          // debugger;
          //  this will get fired on inital load as well as when ever there is a change in the data
          eventsRef.on("value", function(snapshot) {
            var data = snapshot.val();
            var elist = {};
            // debugger;
            for (var key in data) {
              // debugger;
              if (myEvents.includes(key)) {
                name = data[key].name ? data[key].name : '';
                date = data[key].date;
                club = data[key].club;
                // if (name.trim().length > 0) {
                if (typeof elist[club] === 'undefined') {
                  elist[club] = [];
                }
                  elist[club].push({
                    key: key,
                    name: name,
                    date: date,
                    club: club,
                    description: data[key].description,
                    room: data[key].room,
                    email: data[key].email,
                    time: data[key].time
                  })
              }
            }
            console.log(elist);
            // debugger;
            var clublis = '';
            for (club in elist) {
              clublis +=  '<div class="block-header" style="text-transform: uppercase;">' + club + '</div>' +
                      '<div class="list components-list">';
              elis = '<ul>'
              var events = elist[club];

              for (var i = 0; i < events.length; i++) {

                var longDateStr = moment(events[i].date, 'Y-M-D').format('ddd MMM D');
                elis += '<li class = "swipeout">' +
                  '<div class="swipeout-content">' +
                  '<a class="item-content item-link" href="/view-my-event/' + events[i].key + '">' +

                  ' <div class="item-inner">' + longDateStr + ':  ' + events[i].name + ' </div>' +
                  ' </a>' +
                  ' </div>' +
                  '<div class="swipeout-actions-right">' +
                  // ' <a href="#" class="color-orange" onclick=eventUpdate("' + events[i].key + '");>Edit</a>' +
                  ' <a href="#" data-confirm="Are you sure you want to delete this item?" class="swipeout-delete">Delete</a>' +
                  // ' <a href="#" class="swipeout-delete" onclick=eventRemove("' + events[i].key + '");>Delete</a></div>' +
                  '</div>' +
                  '</li>';
              };
              elis += '</ul>'
              clublis += elis + '</div></div>'
            }
            // elis += '</ul>'
            // console.log(elis);
            $$('#myEventList').html(clublis);
          })

        });


      },
      pageAfterOut: function() {
        refreshEventPage()
      }

    }
  };
</script>
